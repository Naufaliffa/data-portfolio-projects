-- REVENUE BY STATE

SELECT
  c.state,
  COUNT(DISTINCT c.id) AS customer_count,
  COUNT(DISTINCT o.id) AS orders_count,
  ROUND(SUM(o.total_amount)::numeric, 2) AS total_revenue,
  ROUND(AVG(o.total_amount)::numeric, 2) AS avg_order_value,
  ROUND(
    SUM(o.total_amount) / COUNT(DISTINCT c.id), 2
  ) AS revenue_per_customer
FROM customers c
JOIN orders o ON c.id = o.customer_id
WHERE o.status = 'delivered'
GROUP BY c.state
HAVING COUNT(DISTINCT o.id) >= 10
ORDER BY total_revenue DESC;

-- City Performance (Top 20)
SELECT
  c.city,
  c.state,
  COUNT(DISTINCT c.id) AS customers,
  COUNT(DISTINCT o.id) AS orders,
  ROUND(SUM(o.total_amount)::numeric, 2) AS revenue
FROM customers c
JOIN orders o ON c.id = o.customer_id
WHERE o.status = 'delivered'
GROUP BY c.city, c.state
HAVING COUNT(DISTINCT o.id) >= 5
ORDER BY revenue desc
LIMIT 20;
  
  
